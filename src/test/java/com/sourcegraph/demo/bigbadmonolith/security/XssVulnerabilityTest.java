package com.sourcegraph.demo.bigbadmonolith.security;

import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Stream;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * T024: XSS vulnerability tests — verify that user-supplied values rendered
 * in JSP output are properly escaped to prevent stored XSS attacks.
 */
class XssVulnerabilityTest {

    private static final Path WEBAPP_ROOT = Paths.get("src/main/webapp");

    @Test
    void jspFilesShouldNotUseRawExpressionForUserData() throws IOException {
        List<String> violations = new ArrayList<>();

        try (Stream<Path> paths = Files.walk(WEBAPP_ROOT)) {
            paths.filter(p -> p.toString().endsWith(".jsp"))
                 .forEach(path -> {
                     try {
                         List<String> lines = Files.readAllLines(path);
                         for (int i = 0; i < lines.size(); i++) {
                             String line = lines.get(i);
                             if (line.contains("<%=") && !line.contains("String.format")
                                     && !line.contains("totalCustomers") && !line.contains("totalUsers")
                                     && !line.contains("totalRevenue") && !line.contains("totalHours")
                                     && !line.contains("df.format") && !line.contains("monthlyTotal")
                                     && !line.contains("monthlyHours") && !line.contains("totalAmount")
                                     && !line.contains("count") && !line.contains("getYear")
                                     && !line.contains("getHourlyRate") && !line.contains("getHours")
                                     && !line.contains("getDate(") && !line.contains("getDouble")
                                     && !line.contains("getDateLogged") && !line.contains("getCreatedAt")
                                     && !line.contains("LocalDate.now")
                                     && (line.contains(".getName()") || line.contains(".getEmail()")
                                     || line.contains(".getAddress()") || line.contains(".getNote()")
                                     || line.contains("getMessage()") || line.contains(".getString(")
                                     || line.contains("customerName") || line.contains("customerEmail"))) {
                                 if (!line.contains("escapeXml") && !line.contains("escapeHtml")
                                         && !line.contains("HtmlUtils.htmlEscape")) {
                                     violations.add(path.getFileName() + ":" + (i + 1) + " → " + line.trim());
                                 }
                             }
                         }
                     } catch (IOException e) {
                         throw new RuntimeException(e);
                     }
                 });
        }

        assertThat(violations)
                .as("JSP files rendering user-supplied data without XSS escaping")
                .isEmpty();
    }
}
